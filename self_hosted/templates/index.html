{% extends 'base.html' %}

{% block title %}OG Strategy Lab - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12 mb-4">
        <h1 class="mb-4">OG Strategy Lab Dashboard</h1>
    </div>
    
    <!-- Status Cards -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Signal Status</h5>
                    <i class="fa fa-bolt fa-2x text-primary"></i>
                </div>
                <h3 class="mb-0" id="signalStatus">Online</h3>
                <small class="text-muted">Processing signals in real-time</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Discord</h5>
                    <i class="fab fa-discord fa-2x text-primary"></i>
                </div>
                <h3 class="mb-0" id="discordStatus">Connected</h3>
                <small class="text-muted">Sending alerts to Discord</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Alpaca</h5>
                    <i class="fa fa-chart-line fa-2x text-primary"></i>
                </div>
                <h3 class="mb-0" id="alpacaStatus">Connected</h3>
                <small class="text-muted">Paper trading mode active</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Socket.IO</h5>
                    <i class="fa fa-wifi fa-2x text-primary"></i>
                </div>
                <h3 class="mb-0" id="socketStatus">Connected</h3>
                <small class="text-muted"><span id="activeClients">1</span> active clients</small>
            </div>
        </div>
    </div>
    
    <!-- Recent Signals -->
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Recent Signals</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>Confidence</th>
                                <th>Price</th>
                                <th>Timeframe</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="signalsTable">
                            <!-- Signals will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <a href="/signals" class="btn btn-sm btn-primary">View All Signals</a>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <button id="testDiscordBtn" class="btn btn-outline-primary">
                        <i class="fab fa-discord me-2"></i> Test Discord Alert
                    </button>
                    <button id="testSignalBtn" class="btn btn-outline-primary">
                        <i class="fa fa-bolt me-2"></i> Generate Test Signal
                    </button>
                    <button id="viewAccountBtn" class="btn btn-outline-primary">
                        <i class="fa fa-user me-2"></i> View Alpaca Account
                    </button>
                    <button id="systemStatusBtn" class="btn btn-outline-primary">
                        <i class="fa fa-gauge-high me-2"></i> System Status
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Connect to Socket.IO server
        const socket = io();
        
        // Socket.IO events
        socket.on('connect', function() {
            console.log('Connected to Socket.IO server');
            document.getElementById('socketStatus').textContent = 'Connected';
            document.getElementById('socketStatus').classList.add('text-success');
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from Socket.IO server');
            document.getElementById('socketStatus').textContent = 'Disconnected';
            document.getElementById('socketStatus').classList.remove('text-success');
            document.getElementById('socketStatus').classList.add('text-danger');
        });
        
        socket.on('server_ready', function(data) {
            console.log('Server ready:', data);
        });
        
        socket.on('signals', function(data) {
            console.log('Signals received:', data);
            updateSignalsTable(data.signals);
        });
        
        socket.on('new_signal', function(data) {
            console.log('New signal received:', data);
            
            // Create toast notification
            const toastHtml = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">${data.symbol} ${data.direction}</strong>
                        <small>Just now</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        New signal detected for ${data.symbol} at $${data.price_at_signal}
                    </div>
                </div>
            `;
            
            // Add toast to container
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            toastContainer.innerHTML = toastHtml;
            document.body.appendChild(toastContainer);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toastContainer.remove();
            }, 5000);
            
            // Request updated signals
            socket.emit('request_signals');
        });
        
        // Request initial signals
        socket.emit('request_signals');
        
        // Quick action buttons
        document.getElementById('testDiscordBtn').addEventListener('click', function() {
            fetch('/system/test_discord')
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error sending test Discord message');
                });
        });
        
        document.getElementById('testSignalBtn').addEventListener('click', function() {
            fetch('/system/test_signal')
                .then(response => response.json())
                .then(data => {
                    console.log('Test signal response:', data);
                    alert('Test signal generated: ' + data.signal.symbol);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error generating test signal');
                });
        });
        
        document.getElementById('viewAccountBtn').addEventListener('click', function() {
            fetch('/api/account')
                .then(response => response.json())
                .then(data => {
                    console.log('Account info:', data);
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        alert(`Account: ${data.id}\nStatus: ${data.status}\nEquity: $${data.portfolio_value}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching account info');
                });
        });
        
        document.getElementById('systemStatusBtn').addEventListener('click', function() {
            window.location.href = '/system';
        });
        
        // Update signals table
        function updateSignalsTable(signals) {
            const tableBody = document.getElementById('signalsTable');
            tableBody.innerHTML = '';
            
            if (signals && signals.length > 0) {
                signals.forEach(signal => {
                    // Parse indicators if it's a string
                    let indicators = signal.indicators;
                    if (typeof indicators === 'string') {
                        try {
                            indicators = JSON.parse(indicators);
                        } catch (e) {
                            indicators = {};
                        }
                    }
                    
                    // Format date
                    const date = new Date(signal.timestamp);
                    const formattedDate = date.toLocaleString();
                    
                    // Create row
                    const row = document.createElement('tr');
                    row.className = signal.direction === 'BEARISH' ? 'table-danger' : 'table-success';
                    
                    row.innerHTML = `
                        <td><strong>${signal.symbol}</strong></td>
                        <td>${signal.direction}</td>
                        <td>${signal.confidence}</td>
                        <td>$${signal.price_at_signal}</td>
                        <td>${indicators.timeframe || 'N/A'}</td>
                        <td>${formattedDate}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="text-center">No signals available</td>
                `;
                tableBody.appendChild(row);
            }
        }
        
        // Periodically check Socket.IO status
        setInterval(function() {
            if (socket.connected) {
                socket.emit('health_check');
            }
        }, 30000);
    });
</script>
{% endblock %}